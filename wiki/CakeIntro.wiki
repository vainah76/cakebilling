#summary Как это всё работает?

====Состав системы====
Система состоит из нескольких независимых модулей:

  * *pptpd* - менеджер VPN соединений. Обеспечивает первоначальное подключение и обращение к pppd.
  * *pppd* - транспортный инкапсулятор туннелей. Обеспечивает инкапсуляцию PPP в IP протокол.
  * *FreeRADIUS* - RADIUS сервер. Обеспечивает AAA (Authorization, Authentication, and Accounting).
  * *PostgreSQL* - сервер СУБД. Обеспечивает хранение аккаунтов, информации о траффике, содержит необходимую бизнес-логику для учёта потребляемого траффика, лимитирования доступа в интернет, а так же обеспечивает целостность данных.

====Механизм соединения====
  * На стороне клиента создаем подключение к VPN сети.
  * Далее при попытке подключения к pptpd серверу он обращается к pppd.
  * pppd запрашивает авторизацию у RADIUS сервера.
  * RADIUS сервер обращается к СУБД и на основе полученных данных формирует пакет.
  * pppd получает или разрешающий или запрещающий пакет от RADIUS.
  * Про получении разрешающего пакета pppd устанавливает различные лимиты (время, траффик) на пользователя, если необходимые аттрибуты содержались в пакете.
  * После этого pppd отправляет RADIUS серверу пакет о старте сессии.
  * Если в разрешающем пакете было указано отсылать промежуточные значения о сессии.
  * Сессия завершается или разрывом соединения пользователем или pppd при превышении им лимитов.
  * При завершении сессии pppd отсылает RADIUS сервер пакет о завершении сессии.

====Порядок обмена пакетами (в терминах RADIUS протокола)====


|| *шаг* || *пакет* || *цель* || *-* || *цель* || *атрибуты* || *примечания* ||
|| * _авторизация_ * || || || || || || ||
|| 1 || auth-request || pppd || > || radius || username, userpassword || запрос на существоание юзера в базе||
|| 2 || auth-accept/auth-reject || pppd || < || radius || yes or no || есть/нет ||
|| * _получение reply пакета/отлуп_ * ||  || || || || || ||
|| 3 || auth-reply || pppd || < || radius || traffic limit, time limit || ответ ||
|| * _работа на линии_ * || || || || || || ||
|| 5 || acct-start || pppd || > || radius || current datetime, username, session id || старт сессии||
|| 6 || acct-alive || pppd || > || radius || current datetime, session id, traffic || обновление данных сессии ||
|| ... || acct-alive || ppd || > || radius || ... || повторение с заданным периодом ||
|| 7 || acct-stop || pppd || > || radius || current datetime, traffic || стоп сессии ||
|| * _отлуп_ * ||  || || || || || ||









